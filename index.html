<!-- index.html – Mapa DR-4671 Barranquitas conectado a tu Google Sheet (autoload) -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mapa DR-4671 Barranquitas (conectado a Google Sheets)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  #panel { position:fixed; right:12px; top:12px; z-index:10000; background:white;
           border:2px solid #1e88e5; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.25); width:380px; }
  #panel h4 { margin: 0 0 6px 0; color:#1e88e5; }
  #panel code { font-size:11px; word-break:break-all; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h4>Datos en vivo (Google Sheets)</h4>
  <div style="font-size:13px; margin-bottom:6px;">Conectado a:<br>
    <code>https://docs.google.com/spreadsheets/d/e/2PACX-1vT2GDDraOY7CZLm3lH4wKSWmywyd8ll3XqjxFeFpdmzS_UY1VeaXVvGecFzq7yOtg2fqigQ0gBUCxB2/pub?gid=296546725&single=true&output=csv</code></div>
  <button id="btnReload" style="padding:6px 10px">Recargar desde Sheet</button>
  <small style="display:block;margin-top:6px;">Se actualiza al abrir; usa el botón para refrescar manualmente.</small>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2GDDraOY7CZLm3lH4wKSWmywyd8ll3XqjxFeFpdmzS_UY1VeaXVvGecFzq7yOtg2fqigQ0gBUCxB2/pub?gid=296546725&single=true&output=csv";

/* ====== Datos embebidos del KMZ (Barranquitas): puntos, municipio, barrios y máscara PR ======
   - BASE_POINTS: marcadores (lat/lng) + PW + Damage + Camino (del KMZ)
   - GEO_MUNICIPIO / GEO_BARRIOS: polígonos
   - GEO_MASK: máscara gris para destacar el municipio
*/
const BASE_POINTS = [{"name": "pw-52 141479 Barranquitas Damage 01", "road": "", "lat": 18.178384999999998, "lng": -66.31397999999999, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 02", "road": "", "lat": 18.172245, "lng": -66.318265, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 03", "road": "", "lat": 18.162451999999998, "lng": -66.313207, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 04", "road": "", "lat": 18.165617, "lng": -66.302289, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 05", "road": "", "lat": 18.159787, "lng": -66.299273, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 06", "road": "", "lat": 18.171879, "lng": -66.304006, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 07", "road": "", "lat": 18.199658, "lng": -66.323263, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 08", "road": "", "lat": 18.205076, "lng": -66.3147, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 09", "road": "", "lat": 18.191883, "lng": -66.319962, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 10", "road": "", "lat": 18.186511, "lng": -66.321474, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 11", "road": "", "lat": 18.179993, "lng": -66.322163, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 12", "road": "", "lat": 18.183287, "lng": -66.324231, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 13", "road": "", "lat": 18.182457, "lng": -66.326432, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 14", "road": "", "lat": 18.178056, "lng": -66.316714, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 15", "road": "", "lat": 18.18821, "lng": -66.313907, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 16", "road": "", "lat": 18.188599, "lng": -66.310193, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 17", "road": "", "lat": 18.196367, "lng": -66.31194399999999, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 18", "road": "", "lat": 18.199986, "lng": -66.312767, "pw": 52, "damage": 141479}, {"name": "pw-52 141479 Barranquitas Damage 19", "road": "", "lat": 18.198476, "lng": -66.320238, "pw": 52, "damage": 141479}];
const GEO_MUNICIPIO = {"type": "FeatureCollection", "features": [{"type": "Feature", "properties": {"name": "Barranquitas"}, "geometry": {"type": "MultiPolygon", "coordinates": [[[[...]]] ]}}]}; /* ← abreviado para el mensaje; en tu archivo pegado estará completo */
const GEO_BARRIOS = {"type": "FeatureCollection", "features": [{"type":"Feature","properties":{"name":"(polígonos)"},"geometry":{"type":"MultiPolygon","coordinates":[[[[...]]]]}}]}; /* abreviado en este mensaje */
const GEO_MASK = {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-179.9,-89.9],[179.9,-89.9],[179.9,89.9],[-179.9,89.9],[-179.9,-89.9]], /* agujeros */ [[...]]]}};

function normKey(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,''); }
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const rawHeaders = lines.shift().split(',').map(h=>h.trim());
  const headers = rawHeaders.map(h=>normKey(h));
  function unq(s){ return s.replace(/^"(.*)"$/,'$1').replace(/""/g,'"'); }
  return lines.map(line=>{
    let arr=[], cur='', q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){ q=!q; cur+=c; }
      else if(c==',' && !q){ arr.push(cur); cur=''; }
      else { cur+=c; }
    }
    arr.push(cur);
    const obj={};
    headers.forEach((h,i)=> obj[h]=unq(arr[i]||''));
    return obj;
  });
}
function pick(row, keys){
  for(const k of keys){
    const v = row[normKey(k)];
    if(v!==undefined && v!=='') return v;
  }
  return '';
}

const map = L.map('map', { center:[18.183, -66.317], zoom:12, zoomControl:true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & Carto' }).addTo(map);

// Máscara PR (gris)
L.geoJSON(GEO_MASK, {
  style: { fillColor:'#d9d9d9', color:'#d9d9d9', weight:1, fillOpacity:0.4 }
}).addTo(map);

// Municipio (amarillo) y Barrios
L.geoJSON(GEO_MUNICIPIO, {
  style: { fillColor:'#fff7b3', color:'#e0c75a', weight:3, fillOpacity:0.45 },
  onEachFeature:(f,l)=> l.bindTooltip(f.properties.name||'',{sticky:true})
}).addTo(map);
L.geoJSON(GEO_BARRIOS, {
  style: { fillColor:'#ffffff', color:'#333', weight:2, fillOpacity:0.10 },
  onEachFeature:(f,l)=> l.bindTooltip(f.properties.name||'',{sticky:true})
}).addTo(map);

// Capa base del KMZ
const baseCluster = L.markerClusterGroup();
BASE_POINTS.forEach(p=>{
  const html = `<b>Camino:</b> ${p.road||'N/D'}<br><b>PW:</b> ${p.pw??'N/D'}<br><b>Daño #:</b> ${p.damage??'N/D'}`;
  baseCluster.addLayer(L.marker([p.lat, p.lng]).bindPopup(html).bindTooltip(p.road||p.name||'Daño'));
});
baseCluster.options.name = "Daños (desde KMZ)";
map.addLayer(baseCluster);

// Control de capas
let sheetLayer = null;
function rebuildLayerControl(){
  if(window._layerCtrl){ window._layerCtrl.remove(); }
  const overlays = {"Daños (desde KMZ)": baseCluster};
  if(sheetLayer) overlays["Daños (desde Sheet)"] = sheetLayer;
  window._layerCtrl = L.control.layers(null, overlays, {collapsed:false}).addTo(map);
}
rebuildLayerControl();

// Construir capa desde el Sheet
function buildSheetLayer(rows){
  const idx = {};
  rows.forEach(r=>{
    const pw = parseInt(pick(r,['PW #','PW','P/W #','pw #','pw']));
    const dmg = parseInt(pick(r,['Damage #','Damage','Daño #','damage#']));
    if(isFinite(pw) && isFinite(dmg)) idx[pw+'|'+dmg] = r;
  });
  const cluster = L.markerClusterGroup();
  BASE_POINTS.forEach(b=>{
    const key = (b.pw!=null && b.damage!=null) ? (b.pw+'|'+b.damage) : null;
    const row = key && idx[key] ? idx[key] : {};
    const camino = pick(row,['Road Name','Camino','road','road name']) || (b.road || 'N/D');
    const status = pick(row,['Status','Estatus','status','estatus']) || 'N/D';
    const proj = pick(row,['Project #','Project Number','Proyecto #','project#','project number']) || 'N/D';
    const html = `<b>Camino:</b> ${camino}<br><b>Proyecto #:</b> ${proj}<br><b>PW:</b> ${b.pw??'N/D'}<br><b>Daño #:</b> ${b.damage??'N/D'}<br><b>Estatus:</b> ${status}`;
    cluster.addLayer(L.marker([b.lat,b.lng]).bindPopup(html).bindTooltip(camino));
  });
  cluster.options.name = "Daños (desde Sheet)";
  return cluster;
}

// Cargar CSV (auto al abrir y con botón)
function loadSheet(){
  return fetch(CSV_URL).then(r=>r.text()).then(txt=>{
    const rows = parseCSV(txt);
    if(sheetLayer) map.removeLayer(sheetLayer);
    sheetLayer = buildSheetLayer(rows);
    map.addLayer(sheetLayer);
    rebuildLayerControl();
  });
}
document.getElementById('btnReload').addEventListener('click', function(e){
  e.stopPropagation();
  loadSheet();
});
loadSheet().catch(err=>alert('No se pudo leer el CSV: '+err));
</script>
</body>
</html>
