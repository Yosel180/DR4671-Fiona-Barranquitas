<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mapa DR-4671 Barranquitas — SOLO datos del Sheet</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
  html, body, #map { height:100%; margin:0; }
  #panel { position:fixed; right:12px; top:12px; z-index:10000; background:#fff;
           border:1px solid #bbb; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.2); width:360px; font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  #panel h4 { margin:0 0 6px 0; color:#1e88e5; font-size:16px; }
  #panel code { font-size:11px; word-break:break-all; display:block; }
  #panel button { padding:6px 10px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h4>Datos en vivo (Google Sheets)</h4>
  <div>Conectado a:</div>
  <code>https://docs.google.com/spreadsheets/d/e/2PACX-1vT2GDDraOY7CZLm3lH4wKSWmywyd8ll3XqjxFeFpdmzS_UY1VeaXVvGecFzq7yOtg2fqigQ0gBUCxB2/pub?gid=296546725&single=true&output=csv</code>
  <button id="btnReload">Recargar desde Sheet</button>
  <small style="display:block;margin-top:6px;">Se carga automáticamente al abrir; el botón fuerza actualización.</small>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ===== CONFIG =====
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2GDDraOY7CZLm3lH4wKSWmywyd8ll3XqjxFeFpdmzS_UY1VeaXVvGecFzq7yOtg2fqigQ0gBUCxB2/pub?gid=296546725&single=true&output=csv";

// Coordenadas base (del KMZ) para ubicar cada PW+Damage
const BASE_POINTS = [
  {"name":"pw-52 141479 Barranquitas Damage 01","road":"","lat":18.178385,"lng":-66.31398,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 02","road":"","lat":18.172245,"lng":-66.318265,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 03","road":"","lat":18.162452,"lng":-66.313207,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 04","road":"","lat":18.165617,"lng":-66.302289,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 05","road":"","lat":18.159787,"lng":-66.299273,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 06","road":"","lat":18.171879,"lng":-66.304006,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 07","road":"","lat":18.199658,"lng":-66.323263,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 08","road":"","lat":18.205076,"lng":-66.3147,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 09","road":"","lat":18.191883,"lng":-66.319962,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 10","road":"","lat":18.186511,"lng":-66.321474,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 11","road":"","lat":18.179993,"lng":-66.322163,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 12","road":"","lat":18.183287,"lng":-66.324231,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 13","road":"","lat":18.182457,"lng":-66.326432,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 14","road":"","lat":18.178056,"lng":-66.316714,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 15","road":"","lat":18.18821,"lng":-66.313907,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 16","road":"","lat":18.188599,"lng":-66.310193,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 17","road":"","lat":18.196367,"lng":-66.311944,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 18","road":"","lat":18.199986,"lng":-66.312767,"pw":52,"damage":141479},
  {"name":"pw-52 141479 Barranquitas Damage 19","road":"","lat":18.198476,"lng":-66.320238,"pw":52,"damage":141479}
];

// ===== MAPA =====
const center = BASE_POINTS.reduce((a,p)=>[a[0]+p.lat, a[1]+p.lng],[0,0]).map(v=>v/BASE_POINTS.length);
const map = L.map('map', { center: center, zoom: 12, zoomControl: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & Carto' }).addTo(map);

// Control de capas (solo usaremos la del Sheet)
let sheetLayer = null;
function rebuildLayerControl(){
  if(window._layerCtrl){ window._layerCtrl.remove(); }
  const overlays = {};
  if(sheetLayer) overlays["Daños (desde Sheet)"] = sheetLayer;
  window._layerCtrl = L.control.layers(null, overlays, {collapsed:false}).addTo(map);
}
rebuildLayerControl();

// ===== SHEET =====
function normKey(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,''); }
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const rawHeaders = lines.shift().split(',').map(h=>h.trim());
  const headers = rawHeaders.map(h=>normKey(h));
  function unq(s){ return s.replace(/^"(.*)"$/,'$1').replace(/""/g,'"'); }
  return lines.map(line=>{
    let arr=[], cur='', q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){ q=!q; cur+=c; }
      else if(c==',' && !q){ arr.push(cur); cur=''; }
      else { cur+=c; }
    }
    arr.push(cur);
    const obj={}; headers.forEach((h,i)=> obj[h]=unq(arr[i]||'')); return obj;
  });
}
function pick(row, keys){
  for(const k of keys){
    const v = row[normKey(k)];
    if(v!==undefined && v!=='') return v;
  }
  return '';
}

// Construir capa MOSTRANDO SOLO lo que está en el Sheet (inner join PW|Damage)
function buildSheetOnlyLayer(rows){
  const idx = {};
  rows.forEach(r=>{
    const pw = parseInt(pick(r,['PW #','PW','P/W #','pw #','pw']));
    const dmg = parseInt(pick(r,['Damage #','Damage','Daño #','damage#']));
    if(isFinite(pw) && isFinite(dmg)) idx[pw+'|'+dmg] = r;
  });

  const cluster = L.markerClusterGroup();
  const seen = new Set(); // para evitar duplicados exactos

  BASE_POINTS.forEach(b=>{
    const key = (b.pw!=null && b.damage!=null) ? (b.pw+'|'+b.damage) : null;
    if(!key || !idx[key]) return; // << SOLO si existe en el Sheet

    const row = idx[key];
    const camino = pick(row,['Road Name','Camino','road','road name']) || (b.road || 'N/D');
    const status = pick(row,['Status','Estatus','status','estatus']) || 'N/D';
    const proj = pick(row,['Project #','Project Number','Proyecto #','project#','project number']) || 'N/D';

    const dupKey = `${b.lat.toFixed(6)},${b.lng.toFixed(6)},${key}`;
    if(seen.has(dupKey)) return; // evita duplicado
    seen.add(dupKey);

    const html = `<b>Camino:</b> ${camino}<br><b>Proyecto #:</b> ${proj}<br><b>PW:</b> ${b.pw??'N/D'}<br><b>Daño #:</b> ${b.damage??'N/D'}<br><b>Estatus:</b> ${status}`;
    cluster.addLayer(L.marker([b.lat,b.lng]).bindPopup(html).bindTooltip(camino));
  });

  cluster.options.name = "Daños (desde Sheet)";
  return cluster;
}

function loadSheet(){
  return fetch(CSV_URL, {mode:'cors', cache:'no-store'})
    .then(r=>r.text())
    .then(txt=>{
      const rows = parseCSV(txt);
      if(sheetLayer) map.removeLayer(sheetLayer);
      sheetLayer = buildSheetOnlyLayer(rows);
      map.addLayer(sheetLayer);
      rebuildLayerControl();
    })
    .catch(err=>{
      console.error(err);
      alert('No se pudo leer el CSV. Ver consola (F12) para detalles.');
    });
}

document.getElementById('btnReload').addEventListener('click', e=>{
  e.stopPropagation();
  loadSheet();
});

// Auto-cargar al abrir
loadSheet();
</script>
</body>
</html>
